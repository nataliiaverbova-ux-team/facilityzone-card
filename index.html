<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Zones - Gymlab Hamburg</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .tabs {
            display: flex;
            gap: 0;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            color: #6e6e73;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:first-child {
            color: #1d1d1f;
            border-bottom-color: #1d1d1f;
            font-weight: 500;
        }

        .tab:hover {
            color: #1d1d1f;
        }

        .user-info {
            position: absolute;
            right: 24px;
            font-size: 14px;
            color: #1d1d1f;
        }

        /* Layout */
        .container {
            display: flex;
            min-height: calc(100vh - 57px);
            
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background: #e8e8ed;
            padding: 24px 0;
            border-right: 1px solid #d2d2d7;
        }

        .sidebar-item {
            padding: 12px 24px;
            cursor: pointer;
            color: #6e6e73;
            transition: background 0.2s;
        }

        .sidebar-item:first-child {
            background: #d2d2d7;
            color: #1d1d1f;
            font-weight: 500;
        }

        .sidebar-item:hover {
            background: #d2d2d7;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .breadcrumb {
            font-size: 13px;
            color: #6e6e73;
            margin-bottom: 8px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .page-title-section {
            flex: 1;
            min-width: 300px;
        }

        .content-header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .content-header p {
            font-size: 14px;
            color: #6e6e73;
            line-height: 1.5;

        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-primary {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #1a252f;
        }

        .btn-secondary {
            background: white;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f5f5f7;
        }

        .current-facility-btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Zone Cards */
        .zones-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .zone-card {
            background: white;
            
            border-radius: 12px;
            padding: 20px;
            transition: box-shadow 0.2s;
        }

        .zone-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .zone-header {
            display: flex;
            align-items: center;
            gap: 12px;
            
        }

        .zone-color {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0;
            border: solid 1px #e8e8ed;
        }

        .zone-name {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
        }

        .zone-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .zone-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #f5f5f7;
        }

        .chevron {
            transition: transform 0.2s;
        }

        .chevron.expanded {
            transform: rotate(180deg);
        }

        /* Sub-zones */
        .sub-zones {
            margin-left: 44px;
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sub-zone-card {
            background: #fafafa;
            border: 2px solid #e8e8ed;
            border-radius: 8px;
            padding: 20px;
        }

        .sub-sub-zones {
            margin-left: 44px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Form */
        .zone-form {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border: 2px dashed #d2d2d7;
            border-radius: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .form-input {
            flex: 1;
            min-width: 180px;
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-select {
            flex: 1;
            min-width: 180px;
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 8px;
        }

        .btn-cancel {
            padding: 8px 16px;
            border: 1px solid #d2d2d7;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-add {
            padding: 8px 16px;
            border: none;
            background: #2c3e50;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 24px;
            color: #6e6e73;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #1d1d1f;
        }
        .required {
            color: #d32f2f;
        }


        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }


        .color-input {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            border: 2px solid #d2d2d7;
            cursor: pointer;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 150px;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f5f5f7;
        }

        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .context-menu-item.danger {
            color: #dc3545;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -200px;
                top: 57px;
                height: calc(100vh - 57px);
                z-index: 50;
                transition: left 0.3s;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                padding: 16px;
            }

            .content-header {
                flex-direction: column;
                gap: 16px;
            }

            .zone-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-input,
            .form-select {
                width: 100%;
            }

            .sub-zones,
            .sub-sub-zones {
                margin-left: 20px;
            }

            .user-info {
                position: static;
                margin-left: auto;
                font-size: 12px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-item">Facilities</div>
            <div class="sidebar-item">Facility zones</div>
            <div class="sidebar-item">Facility categories</div>
            <div class="sidebar-item">Facility closures</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="breadcrumb">Settings / Facilities</div>
            
            <div class="content-header">
                <div class="page-title-section">
                    <h1>Facility zones</h1>
                    <p>Facility zones ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum.</p>
                </div>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openAddZoneModal()">Add facility zone</button>
                    <button class="btn-secondary current-facility-btn">
                        <span>üìç</span>
                        <span>Current facility</span>
                    </button>
                </div>
            </div>

            <!-- Zones Container -->
            <div class="zones-container" id="zonesContainer">
                <!-- Zones will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Zone Modal -->
    <div class="modal-overlay" id="zoneModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Add facility zone</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name<span class="required">*</span></label>
                    <input type="text" class="form-input" id="modalName" placeholder="Enter zone name">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select class="form-select" id="modalCategory">
                        <option value="">Select category</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Personal Training">Personal Training</option>
                        <option value="Parking">Parking</option>
                        <option value="Yoga">Yoga</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Relation</label>
                    <select class="form-select" id="modalRelation">
                        <option value="">Select relation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-input" id="modalColor">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-add" onclick="saveZone()">Save zone</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Delete zone</h2>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this zone? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-add" style="background: #dc3545;" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="editZone()">Edit</div>
        <div class="context-menu-item danger" onclick="deleteZone()">Delete</div>
    </div>

    <script>
        // Data structure
        let zones = [
            {
                id: 1,
                name: 'Fitness',
                color: '#a78bfa',
                category: '',
                relations: [],
                children: [],
                expanded: true,
                level: 0
            }
        ];

        let nextId = 2;
        let currentEditingZone = null;
        let currentContextZone = null;
        let currentAddingParent = null;
        let showingForms = {};

        // Category colors
        const categoryColors = {
            'Swimming': '#60a5fa',
            'Personal Training': '#fb923c',
            'Parking': '#a3a3a3',
            'Yoga': '#c084fc'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Add sample data
            zones[0].children = [
                {
                    id: nextId++,
                    name: 'Gym Room 1',
                    color: '#d4e157',
                    category: 'Personal Training',
                    relations: [],
                    children: [],
                    expanded: false,
                    level: 1,
                    parentId: 1
                },
                {
                    id: nextId++,
                    name: 'Boxing Room 1',
                    color: '#ba68c8',
                    category: 'Personal Training',
                    relations: [4],
                    children: [],
                    expanded: false,
                    level: 1,
                    parentId: 1
                },
                {
                    id: nextId++,
                    name: 'Yoga Room 1',
                    color: '#64b5f6',
                    category: 'Yoga',
                    relations: [3],
                    children: [
                        {
                            id: nextId++,
                            name: 'Yoga Stretching',
                            color: '#5c6bc0',
                            category: '',
                            relations: [],
                            children: [],
                            expanded: false,
                            level: 2,
                            parentId: 4
                        },
                        {
                            id: nextId++,
                            name: 'Yoga Mantra',
                            color: '#7986cb',
                            category: '',
                            relations: [],
                            children: [],
                            expanded: false,
                            level: 2,
                            parentId: 4
                        }
                    ],
                    expanded: true,
                    level: 1,
                    parentId: 1
                }
            ];

            renderZones();
        });

        // Generate random color
        function generateRandomColor() {
            const colors = ['#a78bfa', '#60a5fa', '#fb923c', '#f87171', '#34d399', '#fbbf24', '#c084fc', '#64b5f6', '#ba68c8', '#d4e157'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            document.getElementById('modalColor').value = randomColor;
        }

        // Render zones
        function renderZones() {
            const container = document.getElementById('zonesContainer');
            container.innerHTML = '';
            zones.forEach(zone => {
                container.appendChild(renderZone(zone));
            });
        }

        function renderZone(zone, isSubZone = false) {
            const card = document.createElement('div');
            card.className = isSubZone ? 'sub-zone-card' : 'zone-card';
            card.dataset.zoneId = zone.id;

            const header = document.createElement('div');
            header.className = 'zone-header';

            // Chevron (only if has children)
            if (zone.children && zone.children.length > 0) {
                const chevron = document.createElement('button');
                chevron.className = 'icon-btn';
                chevron.innerHTML = `<svg class="chevron ${zone.expanded ? 'expanded' : ''}" width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
                chevron.onclick = () => toggleExpand(zone.id);
                header.appendChild(chevron);
            }

            // Color circle
            const colorCircle = document.createElement('div');
            colorCircle.className = 'zone-color';
            colorCircle.style.backgroundColor = zone.color;
            header.appendChild(colorCircle);

            // Zone name
            const name = document.createElement('div');
            name.className = 'zone-name';
            name.textContent = zone.name;
            header.appendChild(name);

            // Badges
            const badges = document.createElement('div');
            badges.className = 'zone-badges';
            
            // Category badge
            if (zone.category) {
                const categoryBadge = document.createElement('div');
                categoryBadge.className = 'badge';
                categoryBadge.style.backgroundColor = categoryColors[zone.category] + '33';
                categoryBadge.style.color = categoryColors[zone.category];
                categoryBadge.innerHTML = `
                    <div class="badge-icon" style="background-color: ${categoryColors[zone.category]}"></div>
                    ${zone.category}
                `;
                badges.appendChild(categoryBadge);
            }

            // Relation badges
            if (zone.relations && zone.relations.length > 0) {
                zone.relations.forEach(relId => {
                    const relZone = findZoneById(relId);
                    if (relZone) {
                        const relBadge = document.createElement('div');
                        relBadge.className = 'badge';
                        relBadge.style.backgroundColor = '#e8e8ed';
                        relBadge.style.color = '#6e6e73';
                        relBadge.innerHTML = `
                            <div class="badge-icon" style="background-color: ${relZone.color}"></div>
                            ${relZone.name}
                        `;
                        badges.appendChild(relBadge);
                    }
                });
            }

            header.appendChild(badges);

            // Actions
            const actions = document.createElement('div');
            actions.className = 'zone-actions';

            // Add sub-zone button
            const addBtn = document.createElement('button');
            addBtn.className = 'icon-btn';
            addBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>`;
            addBtn.onclick = (e) => {
                e.stopPropagation();
                showAddForm(zone.id);
            };
            actions.appendChild(addBtn);

            // Context menu button
            const menuBtn = document.createElement('button');
            menuBtn.className = 'icon-btn';
            menuBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <circle cx="10" cy="5" r="1.5" fill="currentColor"/>
                <circle cx="10" cy="10" r="1.5" fill="currentColor"/>
                <circle cx="10" cy="15" r="1.5" fill="currentColor"/>
            </svg>`;
            menuBtn.onclick = (e) => {
                e.stopPropagation();
                showContextMenu(e, zone.id);
            };
            actions.appendChild(menuBtn);

            header.appendChild(actions);
            card.appendChild(header);

            // Add form if showing
            if (showingForms[zone.id]) {
                card.appendChild(renderAddForm(zone.id, zone.level));
            }

            // Sub-zones
            if (zone.children && zone.children.length > 0 && zone.expanded) {
                const subZones = document.createElement('div');
                subZones.className = zone.level === 0 ? 'sub-zones' : 'sub-sub-zones';
                zone.children.forEach(child => {
                    subZones.appendChild(renderZone(child, true));
                });
                card.appendChild(subZones);
            }

            return card;
        }

        function renderAddForm(parentId, level) {
            const form = document.createElement('div');
            form.className = 'zone-form';

            // Color circle
            const randomColor = generateRandomColorValue();
            const colorCircle = document.createElement('div');
            colorCircle.className = 'zone-color';
            colorCircle.style.backgroundColor = randomColor;
            colorCircle.dataset.color = randomColor;
            form.appendChild(colorCircle);

            // Name input
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'form-input';
            nameInput.placeholder = 'Name';
            form.appendChild(nameInput);

            // Category select
            const categorySelect = document.createElement('select');
            categorySelect.className = 'form-select';
            categorySelect.innerHTML = `
                <option value="">Assign category</option>
                <option value="Swimming">Swimming</option>
                <option value="Personal Training">Personal Training</option>
                <option value="Parking">Parking</option>
                <option value="Yoga">Yoga</option>
            `;
            form.appendChild(categorySelect);

            // Relation select
            const relationSelect = document.createElement('select');
            relationSelect.className = 'form-select';
            relationSelect.innerHTML = '<option value="">Add relation</option>';
            
            // Get available relations (same level siblings)
            const siblings = getSiblings(parentId, level + 1);
            siblings.forEach(sibling => {
                const option = document.createElement('option');
                option.value = sibling.id;
                option.textContent = sibling.name;
                relationSelect.appendChild(option);
            });
            form.appendChild(relationSelect);

            // Actions
            const formActions = document.createElement('div');
            formActions.className = 'form-actions';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn-cancel';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.onclick = () => hideAddForm(parentId);
            formActions.appendChild(cancelBtn);

            const addBtn = document.createElement('button');
            addBtn.className = 'btn-add';
            addBtn.textContent = 'Add zone';
            addBtn.onclick = () => {
                const name = nameInput.value.trim();
                if (!name) {
                    alert('Please enter a name');
                    return;
                }

                const newZone = {
                    id: nextId++,
                    name: name,
                    color: colorCircle.dataset.color,
                    category: categorySelect.value,
                    relations: relationSelect.value ? [parseInt(relationSelect.value)] : [],
                    children: [],
                    expanded: false,
                    level: level + 1,
                    parentId: parentId
                };

                // Add relation bidirectionally
                if (newZone.relations.length > 0) {
                    const relZone = findZoneById(newZone.relations[0]);
                    if (relZone && !relZone.relations.includes(newZone.id)) {
                        relZone.relations.push(newZone.id);
                    }
                }

                // Add to parent
                const parent = findZoneById(parentId);
                if (parent) {
                    parent.children.push(newZone);
                    parent.expanded = true;
                }

                hideAddForm(parentId);
                renderZones();
            };
            formActions.appendChild(addBtn);

            form.appendChild(formActions);

            return form;
        }

        function generateRandomColorValue() {
            const colors = ['#a78bfa', '#60a5fa', '#fb923c', '#f87171', '#34d399', '#fbbf24', '#c084fc', '#64b5f6', '#ba68c8', '#d4e157'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function showAddForm(zoneId) {
            showingForms[zoneId] = true;
            renderZones();
        }

        function hideAddForm(zoneId) {
            delete showingForms[zoneId];
            renderZones();
        }

        function toggleExpand(zoneId) {
            const zone = findZoneById(zoneId);
            if (zone) {
                zone.expanded = !zone.expanded;
                renderZones();
            }
        }

        // Modal functions
        function openAddZoneModal() {
            currentEditingZone = null;
            document.getElementById('modalTitle').textContent = 'Add facility zone';
            document.getElementById('modalName').value = '';
            document.getElementById('modalCategory').value = '';
            generateRandomColor();
            
            // Populate relations (only top-level zones)
            const relationSelect = document.getElementById('modalRelation');
            relationSelect.innerHTML = '<option value="">Add relation</option>';
            zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.id;
                option.textContent = zone.name;
                relationSelect.appendChild(option);
            });

            document.getElementById('zoneModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('zoneModal').classList.remove('active');
        }

        function saveZone() {
            const name = document.getElementById('modalName').value.trim();
            const color = document.getElementById('modalColor').value;
            const category = document.getElementById('modalCategory').value;
            const relation = document.getElementById('modalRelation').value;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            if (currentEditingZone) {
                // Edit existing zone
                currentEditingZone.name = name;
                currentEditingZone.color = color;
                currentEditingZone.category = category;
                
                // Update relations
                const oldRelations = [...currentEditingZone.relations];
                currentEditingZone.relations = relation ? [parseInt(relation)] : [];

                // Remove old bidirectional relations
                oldRelations.forEach(relId => {
                    if (!currentEditingZone.relations.includes(relId)) {
                        const relZone = findZoneById(relId);
                        if (relZone) {
                            relZone.relations = relZone.relations.filter(id => id !== currentEditingZone.id);
                        }
                    }
                });

                // Add new bidirectional relation
                if (relation) {
                    const relZone = findZoneById(parseInt(relation));
                    if (relZone && !relZone.relations.includes(currentEditingZone.id)) {
                        relZone.relations.push(currentEditingZone.id);
                    }
                }
            } else {
                // Add new zone
                const newZone = {
                    id: nextId++,
                    name: name,
                    color: color,
                    category: category,
                    relations: relation ? [parseInt(relation)] : [],
                    children: [],
                    expanded: false,
                    level: 0
                };

                // Add bidirectional relation
                if (relation) {
                    const relZone = findZoneById(parseInt(relation));
                    if (relZone) {
                        relZone.relations.push(newZone.id);
                    }
                }

                zones.unshift(newZone);
            }

            closeModal();
            renderZones();
        }

        // Context menu
        function showContextMenu(event, zoneId) {
            currentContextZone = zoneId;
            const menu = document.getElementById('contextMenu');
            menu.classList.add('active');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';

            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
            }, 0);
        }

        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
            document.removeEventListener('click', closeContextMenu);
        }

        function editZone() {
            closeContextMenu();
            const zone = findZoneById(currentContextZone);
            if (!zone) return;

            currentEditingZone = zone;
            document.getElementById('modalTitle').textContent = 'Edit zone';
            document.getElementById('modalName').value = zone.name;
            document.getElementById('modalColor').value = zone.color;
            document.getElementById('modalCategory').value = zone.category;
        

            // Populate relations with siblings
            const relationSelect = document.getElementById('modalRelation');
            relationSelect.innerHTML = '<option value="">Add relation</option>';
            const siblings = getSiblings(zone.parentId, zone.level);
            siblings.forEach(sibling => {
                if (sibling.id !== zone.id) {
                    const option = document.createElement('option');
                    option.value = sibling.id;
                    option.textContent = sibling.name;
                    if (zone.relations.includes(sibling.id)) {
                        option.selected = true;
                    }
                    relationSelect.appendChild(option);
                }
            });

            document.getElementById('zoneModal').classList.add('active');
        }

        function deleteZone() {
            closeContextMenu();
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        function confirmDelete() {
            const zone = findZoneById(currentContextZone);
            if (!zone) return;

            // Remove bidirectional relations
            zone.relations.forEach(relId => {
                const relZone = findZoneById(relId);
                if (relZone) {
                    relZone.relations = relZone.relations.filter(id => id !== zone.id);
                }
            });

            // Remove from parent or top level
            if (zone.level === 0) {
                zones = zones.filter(z => z.id !== zone.id);
            } else {
                removeZoneFromParent(zone.id, zone.parentId);
            }

            closeDeleteModal();
            renderZones();
        }

        // Helper functions
        function findZoneById(id, zoneList = zones) {
            for (const zone of zoneList) {
                if (zone.id === id) return zone;
                if (zone.children) {
                    const found = findZoneById(id, zone.children);
                    if (found) return found;
                }
            }
            return null;
        }

        function removeZoneFromParent(zoneId, parentId) {
            const parent = findZoneById(parentId);
            if (parent && parent.children) {
                parent.children = parent.children.filter(z => z.id !== zoneId);
            }
        }

        function getSiblings(parentId, level) {
            if (level === 0) {
                return zones;
            }
            const parent = findZoneById(parentId);
            return parent ? parent.children : [];
        }

        // Close modal on outside click
        document.getElementById('zoneModal').addEventListener('click', (e) => {
            if (e.target.id === 'zoneModal') {
                closeModal();
            }
        });

        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                closeDeleteModal();
            }
        });
    </script>
</body>
</html>
