<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Zones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9f9fa;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 200px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            flex-shrink: 0;
        }

        .sidebar h3 {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .sidebar-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .sidebar-item.active {
            background-color: #f0f0f0;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
/*
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
*/
            padding: 20px 30px;
        }

        .breadcrumb {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #1976D2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn-outline {
            border: solid 1px #1976D2;
            color: #1976D2;
            background: none;
        }

        .btn-outline:hover {
            border: solid 1px #1565c0;
            color: #1565c0;
            background: #e2ebf2;
        }

        .dropdown-btn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 0px 30px 16px;
        }
        
        .info-alert {
            position: relative;
            background: #e7f4fd;
            color: #1f5284;
            border: solid 1px #5c96d0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            padding: 16px 50px 16px 16px;
            margin-bottom: 20px;
        }
        .info-alert.close {
            display: none;
        }

        .info-alert .modal-close {
            color: #1f5284;
            position: absolute;
            right: 10px;
            top: 10px;
        }
        .info-alert .modal-close:hover {
            color: #146bbf;
        }
        
        .info-alert a { 
            color: #1f5284;
        }
        .info-alert-title .info-icon{
            float: left;
            background-color: #1f5284;
            margin-right: 8px;
            font-size: 11px;
            margin-top: 2px;
        }

        .description {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-top: 16px;
        }

        /* Zone Cards */
        .zones-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }
        .zone-list-header {
            display: flex;
            flex-direction: row;
            gap: 20px;
            font-size: 14px;
            background: #fff;
            padding: 10px 0;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            color: #666;
            margin-bottom: 8px;
        }
        .zone-list-header p{
            float: left;
            margin-right: 6px;
        }
        
        .zone-list-header .info-icon {
            margin-top: 1px;
        }
        .zone-list-header .name{
            width: 53%;
            padding-left: 85px;
        }
        .zone-list-header .relation{
            width: 26%;
        }
        .zone-list-header .category{
            width: 17%;
        }

        .zone-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .zone-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            gap: 12px;
            position: relative;
        }

        .expand-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 18px;
            padding: 0;
            flex-shrink: 0;
        }

        .expand-btn.hidden {
            visibility: hidden;
        }

        .zone-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .zone-name {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .zone-badges {
            display: flex;
            align-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
           width: 40%;
            position: relative;
            
        }
        .zone-badges.category {

            width: 12%;
    
        }
        
        .badge-title {
            font-size: 12px;
            color: #999;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .badge-list { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        
        .zone-relation-parent {
            font-size: 12px;
            color: #999;
            position: absolute;
            top: 30px;
            right: 78px;
            width: 40%;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            position: relative;
            cursor: help;
        }

        .badge.category {
            background-color: #dcddde;
            color: #272f41;
            border-radius: 5px;
        }

        .badge.relation {
            background-color: #cde6f8;
            color: #114d89;
        }
        
        

        .zone-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: #666;
            font-size: 18px;
        }
        .icon-btn i{
            display: block;
            color: #1976D2;
            width: 24px;
            height: 24px;
            border: solid 1px #1976D2;
            border-radius: 50%;
            transition: all 0.2s;
            text-align: center;
        }
        .icon-btn i:hover {
            color: #ffffff;
            background-color: #1976D2;
        }
        
        .icon-btn.context-m:hover {
            background-color: #f0f0f0;
        }

        .zone-children {
            padding: 0 20px 20px 20px;
        }

        .zone-children.collapsed {
            display: none;
        }

        .sub-zone {
            margin-left: 36px;
            margin-top: 12px;
            margin-right: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .sub-sub-zone {
            margin-left: 36px;
            margin-top: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f5f5f5;
        }

        /* Zone Form */
        .zone-form {
            margin-left: 36px;
            margin-top: 12px;
            border: 2px dashed #666;
            border-radius: 8px;
            padding: 20px;
            background-color: white;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .info-icon {
            width: 16px;
            height: 16px;
            background:  #999;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #fff;
            cursor: pointer;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        .helper-text {
            font-size: 13px;
            color: #999;
            padding: 4px;
        }

        .multi-select-container {
            position: relative;
        }

        .multi-select-input {
            min-height: 40px;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .multi-select-placeholder {
            color: #999;
            font-size: 14px;
        }

        .multi-select-tag {
            background-color: #e0e0e0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .multi-select-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .multi-select-dropdown.open {
            display: block;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

        .multi-select-option:hover {
            background-color: #f0f0f0;
        }

        .multi-select-option.disabled {
            color: #999;
            cursor: not-allowed;
        }

        .multi-select-option.disabled:hover {
            background-color: white;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            
        }

        .color-input {
            opacity: 0;
            position: absolute;
            pointer-events: none;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .zone-alert {
            position: relative;
            background: #e7f4fd;
            color: #1f5284;
            border: solid 1px #5c96d0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            padding: 16px 32px 16px 16px;
            margin: 0 20px 16px 56px;
            height: 80px;
            animation: fadeIn 0.3s ease-in;
        }
        .zone-alert.close {
            display: none;
        }

        .zone-alert .modal-close {
            color: #1f5284;
            position: absolute;
            right: 10px;
            top: 10px;
        }
        .zone-alert .modal-close:hover {
            color: #146bbf;
        }
        
        .zone-alert a { 
            color: #1f5284;
        }
        .zone-alert .info-icon{
            float: left;
            background-color: #1f5284;
            margin-right: 8px;
            font-size: 11px;
            margin-top: 2px;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-4px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* Modal/Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            position: relative;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 500;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-actions {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .alert-button {
            width: auto;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #1F5284;
            margin-right: 8px;
            padding: 4px 4px;
            float: right;
            font-weight: 600;
        }
        .alert-button:hover {
            color: #146bbf;
        }
        
        .facility-icon {
            color: #5a7a44;
        }
        
        .modal-subheader {
            background-color: #e8f0dd;
            padding: 8px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subheader-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #5a7a44;
            font-size: 14px;
            cursor: pointer;
        }
        
        .facility-selector {
          position: relative;
        }

        .facility-dropdown-menu {
          display: none;
          position: absolute;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.15);
          padding: 8px 12px;
          z-index: 20;
          width: 300px;
        }

        .facility-dropdown-menu.open {
          display: block;
        }

        .facility-option {
          display: flex;
          align-items: center;
          margin: 4px 0;
        }
        
        .facility-selector {
            position: relative;
        }

        .facility-dropdown-toggle {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .facility-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 4px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            display: none;
        }

        .facility-dropdown-menu.show {
            display: block;
        }

        .facility-option {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .facility-option:hover {
            background-color: #f5f5f5;
        }

        .facility-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        

        /* Context Menu */
        .context-menu {
            position: fixed;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            display: none;
            min-width: 150px;
        }

        .context-menu.open {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        /* Popover */
        .popover {
            position: absolute;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 12px;
            max-width: 300px;
            z-index: 3000;
            display: none;
            font-size: 14px;
            line-height: 1.7;
        }

        .popover.open {
            display: block;
        }

        .popover-with-image {
            max-width: 400px;
        }

        .popover-image {
            width: 100%;
            background-color: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        .popover-image img {
            width: 100%;
            height: auto;
        }
        
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .dialog-overlay.active {
            display: flex;
        }

        .dialog {
            background-color: white;
            width: 1200px;
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .dialog-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            line-height: 1;
            transition: color 0.3s;
        }

        .close-icon:hover {
            color: #333;
        }

        .dialog-content {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        .dialog-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .relations-table {
            width: 100%;
        }

        .table-header {
            display: grid;
            grid-template-columns: 300px 300px 1fr;
            gap: 20px;
            padding: 16px 8px;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .parent-zone-row {
            display: grid;
            grid-template-columns: 300px 300px 1fr;
            gap: 20px;
            padding: 20px 8px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            align-items: start;
            background: #fafafa;
        }

        .parent-zone-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #333;
            
        }

        .expand-icon {
            cursor: pointer;
            transition: transform 0.3s;
            font-size: 12px;
            color: #666;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .sub-zone-row {
            display: grid;
            grid-template-columns: 300px 300px 1fr;
            gap: 20px;
            padding: 16px 8px;
            padding-left: 40px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sub-zone-name {
            color: #555;
        }

        .relation-text {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .relation-text strong {
            color: #333;
            font-weight: 600;
        }

        .dialog-footer {
            padding: 20px 32px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
        }

        .close-button {
            background-color: #2c3e50;
            color: white;
            padding: 10px 32px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .close-button:hover {
            background-color: #34495e;
        }

        .collapsible-content {
            display: none;
        }

        .collapsible-content.active {
            display: block;
        }

        .zone-count {
            color: #666;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -200px;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transition: left 0.3s;
            }

            .sidebar.open {
                left: 0;
            }

            .content {
                padding: 20px;
            }

            .zone-children {
                padding: 0 10px 10px 10px;
            }

            .sub-zone, .sub-sub-zone, .zone-form {
                margin-left: 20px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Delete confirmation */
        .delete-message {
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .required {
            color: #c41e3a;
            margin-left: 2px;
        }
        
        .banner-container {
            background-color: #daebff;
            border-radius: 8px;
            width: 100%;
            overflow: hidden;
            border: 1px solid #5483dd;
            margin-bottom: 20px;
            
        }
        .banner-container.closed {
            display: none;
        }

        .banner-header {
            padding: 16px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .banner-title {
            font-size: 18px;
            font-weight: 600;
            color: #0e3580;
        }
        .banner-title .info-icon {
            float: left;
            margin: 0px 12px 0px 0px;
            background: #1976D2;
            width: 22px;
            height: 22px;
            font-size: 14px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #0e3580;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #2d68d8;
        }

        .slider-container {
            overflow: hidden;
            position: relative;
        }

        .slider-wrapper {
            display: flex;
            transition: transform 0.4s ease-in-out;
        }

        .slide {
            min-width: 100%;
            padding: 8px 16px;
            height: auto;
        }
        .slide-left {
            width: 50%;
            float: left;
            padding: 0 40px 0 0;
            height: auto;
        }
        .slide-right {
            width: 50%;
             float: left;
        }

        .slide-content {
            overflow: hidden;
            border-radius: 6px;
            max-width: 480px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            margin: 0 auto;
            
        }
        .slide-content img{
            width: 100%;
            height: 180px;
        }

        .text-content {
            flex: 1;
        }

        .intro-text {
            color: #0e3580;
            line-height: 1.6;
            margin-bottom: 8px;
            font-size: 14px;
            padding-right: 30px;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            
            margin-bottom: 15px;
        }
        .step-header.top{
            margin-bottom: 10px;
        }

        .step-number {
            background-color: #0e3580;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: #0e3580;
        }

        .step-description {
            color: #0e3580;
            line-height: 1.6;
            font-size: 14px;
            padding-right: 30px;
        }

        .image-placeholder {
            flex: 1;
            background: linear-gradient(135deg, #c8d8e8 0%, #a8c0d8 100%);
            border-radius: 6px;
            max-width: 480px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            margin: 0 auto;
        }

        .banner-footer {
            padding: 10px 16px;
/*            border-top: 1px solid #9cb3e0;*/
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-indicator {
            color: #747c88;
            font-size: 13px;
            margin: 0 auto;
        }

        .next-btn {
            background-color: #daebff;
            border: none;
            padding: 8px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #0e3580;
            transition: all 0.3s;
        }

        .next-btn:hover {
            color: #2267ac;
        }

        .info-text {
            font-size: 13px;
            color: #2c2c2c;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            

            .banner-header,
            .slide,
            .banner-footer {
                padding: 15px 20px;
            }

            .banner-title {
                font-size: 16px;
            }

            .image-placeholder {
                min-height: 150px;
            }
        }

        @media (max-width: 480px) {
            .banner-header,
            .slide,
            .banner-footer {
                padding: 12px 15px;
            }

            .next-btn {
                padding: 6px 18px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h3>Facilities</h3>
            <div class="sidebar-item"><a href="file:///Users/nataliia/Prototype/card-view.html">Facility zones</a></div>
            <div class="sidebar-item"><a href="file:///Users/nataliia/Prototype/facility-category.html">Facility categories</a></div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="breadcrumb">Settings / Facilities</div>
                <div class="header-content">
                    <h1>Facility zones</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addTopLevelZoneBtn">Add facility zone</button>
                        <button class="btn btn-outline" onclick="openDialog()">Review booking relations</button>
                    </div>
                    
                </div>
                <div class="description">
                    Facility zones are specific areas within your sports facility that can be individually defined, managed, and tracked. Each zone represents a physical space ‚Äî such as a fitness area, swimming pool, or sports court ‚Äî allowing you to organize activities, bookings, capacities, and schedules more efficiently.
                </div>
            </div>

            <!-- Content -->
            <div class="content">
<!--
                <div class="info-alert" id="infoAlert">
                    <div class="info-alert-title">
                        <span class="info-icon">i</span>
                        <p>Configuring your facility zones directly affects how bookings and availability are managed for your customers. Incorrect settings may cause double bookings or make resources unavailable. Use your <a href="#">studio plan</a> as a visual guide, and be sure to add <a href="#">Booking Relations</a> if certain zones can‚Äôt be booked at the same time.
                        <a href="#">How to set up your zones correctly?</a> </p>
                    </div>
                    <button class="modal-close" onclick="closeInfoAlert()">√ó</button>
                </div>
-->
               <!-- Banner -->
               <div class="banner-container" id="closeBanner">
                    <div class="banner-header">
                        <h2 class="banner-title"><span class="info-icon">i</span> How to Configure Facility Zones?</h2>
                        <button class="close-btn" onclick="closeBanner()">&times;</button>
                    </div>

                    <div class="slider-container">
                        <div class="slider-wrapper" id="sliderWrapper">
                            <!-- Slide 1 -->
                            <div class="slide">
<!--                                <div class="slide-left">-->
                                    <p class="intro-text">
                                        Configuring your facility zones directly affects how bookings and availability are managed for your customers. Incorrect settings may cause double bookings or make resources unavailable. 
                                    </p>
                                    <div class="step-header top">
                                        <span class="step-number">1</span>
                                        <span class="step-title">Use your studio plan as a visual guide to add zones.</span>
                                    </div>
                                    <p class="intro-text">
                                        Before starting the configuration use your studio plan as a visual guide to ensure you accurately represent physical space and potential conflicts.
                                    </p>
                                     
<!--                                </div>-->
<!--
                                <div class="slide-right">
                                    <div class="slide-content">
                                        <img src="images/Img1.png" alt="">
                                    </div>
                                </div>
-->
                            </div>

                            <!-- Slide 2 -->
                            <div class="slide">
<!--                                <div class="slide-left">-->
                                    <div class="step-header">
                                        <span class="step-number">2</span>
                                        <span class="step-title">Add Booking relations if zones cannot be booked at the same time.</span>
                                    </div>
                                    <p class="step-description">
                                        Add Booking relations for any zones that cannot be booked at the same time due 
                                        to shared space or proximity. You must link zones at the same hierarchy level (e.g., 
                                        Sub-zone to Sub-zone). This prevents simultaneous booking conflicts.
                                    </p>
<!--                                </div>-->
<!--
                                <div class="slide-right">
                                    <div class="slide-content">
                                        <img src="images/Img2.png" alt="">
                                    </div>
                                </div>
-->
                            </div>

                            <!-- Slide 3 -->
                            <div class="slide">
<!--                                <div class="slide-left">-->
                                    <div class="step-header">
                                        <span class="step-number">3</span>
                                        <span class="step-title">Assign Category if zone have to be set as resource in Services.</span>
                                    </div>
                                    <p class="step-description">
                                        Add Categories if the zone needs to be defined as a resource for your services. 
                                        Assigning a Category (like 'Swimming' or 'Yoga') allows you to link that zone to specific 
                                        services, making it bookable by your customers.
                                    </p>
<!--                                </div>-->
<!--
                                <div class="slide-right">
                                    <div class="slide-content">
                                        <div class="image-placeholder">image placeholder</div>
                                    </div>
                                </div>
-->
                            </div>

                            <!-- Slide 4 -->
                            <div class="slide">
<!--                                <div class="slide-left">-->
                                    <div class="step-header">
                                        <span class="step-number">4</span>
                                        <span class="step-title">Review booking relations</span>
                                    </div>
                                    <p class="step-description">
                                        You can review the booking relations at any time. Check the dependency on the sub-zone to ensure the correct booking constraints are applied. Verifying the layout now helps prevent booking issues later.
                                    </p>
<!--                                </div>-->
<!--
                                <div class="slide-right">
                                    <div class="slide-content">
                                        <div class="image-placeholder">image placeholder</div>
                                    </div>
                                </div>
-->
                            </div>
                        </div>
                    </div>

                    <div class="banner-footer">
                        <span class="page-indicator" id="pageIndicator">1 of 4</span>
                        <button class="next-btn" id="nextBtn" onclick="nextSlide()">Next</button>
                    </div>
                </div>
               
                <div class="zone-list-header">
                    <div class="name">Name</div>
                    <div class="relation"><p>Booking relations</p><span class="info-icon" id="dialogRelations">i</span></div>
                    <div class="category"><p>Facility category</p><span class="info-icon" id="dialogCategory">i</span></div>
                </div>
                <div class="zones-list" id="zonesList"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Zone Modal -->
    <div class="modal-overlay" id="zoneModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add top-level Zone</div>
                <button class="modal-close" onclick="closeZoneModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">
                        Name <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="zoneName" placeholder="Enter zone name">
                </div>

                <div id="zoneCategoryGroup" class="form-group">
                    <label class="form-label">
                        Facility category
                        <span class="info-icon" id="dialogCategory">i</span>
                    </label>
                    <select class="form-select" id="zoneCategory">
                        <option value="">Select category</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Personal Training">Personal Training</option>
                        <option value="Parking">Parking</option>
                        <option value="Yoga">Yoga</option>
                        <option value="_addNew">‚ûï Add new category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        Booking relations
                        <span class="info-icon" id="dialogRelations">i</span>
                    </label>
                    <div class="multi-select-container">
                        <div class="multi-select-input" id="relationsInput">
                            <span class="multi-select-placeholder">Select relations</span>
                        </div>
                        <div class="multi-select-dropdown" id="relationsDropdown"></div>
                    </div>
                    <div class="helper-text">Adding a booking relation between zones means that these zones cannot be booked at the same time. This ensures proper space management.</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Color</label>
                    <div class="color-picker-container">
                        <div class="color-preview" id="colorPreview" onclick="document.getElementById('colorInput').click()"></div>
                        <input type="color" class="color-input" id="colorInput">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeZoneModal()">Cancel</button>
                <button class="btn btn-primary" id="saveZoneBtn">Add zone</button>
            </div>
        </div>
    </div>
     <!-- Create Category Modal -->
    <div class="modal-overlay" id="addCategoryModal">
      <div class="modal">
        <div class="modal-header">
          <h2 id="addCategoryTitle" class="modal-title">Create category</h2>
          <button class="modal-close" id="closeAddCategoryBtn">√ó</button>
        </div>
        
        <div class="modal-subheader">
            <div class="subheader-item">
                <span class="facility-icon">üìç</span>
                <span>Edit sharing settings</span>
            </div>
            <div class="facility-selector">
              <button type="button" class="facility-dropdown-toggle" id="facilityToggle">
                <span>Current facility</span>
                <span>‚ñº</span>
              </button>
              <div class="facility-dropdown-menu" id="facilityDropdown">
                <div class="facility-option">
                  <input type="checkbox" id="facility1" value="Studio Hamburg">
                  <label for="facility1">Studio Hamburg</label>
                </div>
                <div class="facility-option">
                  <input type="checkbox" id="facility2" value="Studio Berlin">
                  <label for="facility2">Studio Berlin</label>
                </div>
                <div class="facility-option">
                  <input type="checkbox" id="facility3" value="Studio Warsaw">
                  <label for="facility3">Studio Warsaw</label>
                </div>
                <div class="facility-option">
                  <input type="checkbox" id="facility4" value="Studio Krakow">
                  <label for="facility4">Studio Krakow</label>
                </div>
                <div class="facility-option">
                  <input type="checkbox" id="facility5" value="Studio London">
                  <label for="facility5">Studio London</label>
                </div>
                <div class="facility-option">
                  <input type="checkbox" id="facility6" value="Studio Milan">
                  <label for="facility6">Studio Milan</label>
                </div>
              </div>
          </div>
      </div>

        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Name <span class="required">*</span></label>
            <input type="text" class="form-input" id="categoryName" placeholder="Enter category name">
          </div>

          <div class="form-group">
            <label class="form-label">Color</label>
            <div class="color-input-group">
<!--              <div class="color-preview" id="categoryColorPreview"></div>-->
<!--              <input type="text" id="categoryColorInput" readonly>-->
              <input type="color" class="color-preview" id="categoryColorPicker">
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="btn btn-secondary" id="cancelAddCategoryBtn">Cancel</button>
          <button class="btn btn-primary" id="saveAddCategoryBtn">Create category</button>
        </div>
      </div>
    </div>
    
    <!-- Review dialog -->
    <div class="dialog-overlay" id="dialogOverlay" onclick="closeDialogOnOverlay(event)">
        <div class="dialog">
            <div class="dialog-header">
                <div class="dialog-title">Review booking relations</div>
                <button class="close-icon" onclick="closeDialog()">&times;</button>
            </div>

            <div class="dialog-content">
               <div class="dialog-description"> This is an overview of the booking relations for the existing zones in the system: Court Sports, Workout area, Swimming Pool.</div>
                <div class="relations-table">
                    <div class="table-header">
                        <div>Parent Zone Name</div>
                        <div>Sub Zone Name</div>
                        <div>Booking relations</div>
                    </div>

                    <!-- Court Sports Parent Zone -->
                    <div class="parent-zone-row">
                        <div class="parent-zone-cell">
                            <span class="expand-icon" onclick="toggleZone('court-sports')">‚ñº</span>
                            <span>Court Sports <span class="zone-count">(3)</span></span>
                        </div>
                        <div></div>
                        <div class="relation-text">
                            If the parent element is booked, the sub-zone cannot be booked.
                        </div>
                    </div>

                    <div id="court-sports" class="collapsible-content active">
                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Basketball Court</div>
                            <div class="relation-text">
                                Cannot be booked at the same time with: <strong>Volleyball court 1</strong>, <strong>Volleyball court 2</strong>.
                            </div>
                        </div>

                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Volleyball Court 1</div>
                            <div class="relation-text">
                                Cannot be booked at the same time with: <strong>Basketball Court</strong>.
                            </div>
                        </div>

                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Volleyball Court 2</div>
                            <div class="relation-text">
                                Cannot be booked at the same time with: <strong>Basketball Court</strong>.
                            </div>
                        </div>
                    </div>

                    <!-- Workout Area Parent Zone -->
                    <div class="parent-zone-row">
                        <div class="parent-zone-cell">
                            <span class="expand-icon" onclick="toggleZone('workout-area')">‚ñº</span>
                            <span>Workout area <span class="zone-count">(2)</span></span>
                        </div>
                        <div></div>
                        <div class="relation-text">
                            If the parent element is booked, the sub-zone cannot be booked.
                        </div>
                    </div>

                    <div id="workout-area" class="collapsible-content active">
                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Gym room</div>
                            <div class="relation-text">-</div>
                        </div>

                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Boxing room</div>
                            <div class="relation-text">-</div>
                        </div>
                    </div>

                    <!-- Swimming Pool Parent Zone -->
                    <div class="parent-zone-row">
                        <div class="parent-zone-cell">
                            <span class="expand-icon" onclick="toggleZone('swimming-pool')">‚ñº</span>
                            <span>Swimming Pool <span class="zone-count">(2)</span></span>
                        </div>
                        <div></div>
                        <div class="relation-text">
                            If the parent element is booked, the sub-zone cannot be booked.
                        </div>
                    </div>

                    <div id="swimming-pool" class="collapsible-content active">
                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Swimming lane 1</div>
                            <div class="relation-text">-</div>
                        </div>

                        <div class="sub-zone-row">
                            <div></div>
                            <div class="sub-zone-name">Swimming lane 2</div>
                            <div class="relation-text">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dialog-footer">
                <button class="close-button" onclick="closeDialog()">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Delete Zone</h2>
                <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="delete-message" id="deleteMessage"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-primary" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="editZoneMenuItem">Edit zone</div>
        <div class="context-menu-item" id="deleteZoneMenuItem">Delete zone</div>
    </div>

    <!-- Popovers -->
    <div class="popover" id="categoryInfoPopover">
        Facility Category can be assigned to a zone, allowing that zone to be used as a cross-facility resource for various Services.
    </div>

    <div class="popover popover-with-image" id="relationsInfoPopover">
        The Booking relation describes two or more distinct zones that share a similar area or placement. This relation affects the booking availability of facility zones. <br> <b>Example (from the image)</b>: if the basketball zone is booked, the volleyball zone will not be available for booking.
        <div class="popover-image"><img src="images/relations.png" alt="Booking relation"></div>
    </div>

    <div class="popover" id="badgePopover"></div>

    <script>
        // Data Structure
        let zones = [];
        let currentEditingZone = null;
        let currentParentZone = null;
        let currentLevel = 0; // 0 = top-level, 1 = sub-zone, 2 = sub-sub-zone
        let contextMenuTarget = null;

        // Categories
        const categories = {
            'Swimming': 'Swimming',
            'Personal Training': 'Personal Training',
            'Parking': 'Parking',
            'Yoga': 'Yoga'
        };
        
        const defaultZones = [
          {
            id: 'zone-1',
            name: 'Workout area',
            category: 'Personal Training',
            color: '#a855f7',
            relations: [],
            children: [
               {
                id: 'zone-2',
                name: 'Gym room',
                category: '',
                color: '#a0d468',
                relations: [],
                children: [],
                expanded: true
              },
              {
                id: 'zone-3',
                name: 'Boxing room',
                category: '',
                color: '#5f9ea0',
                relations: [],
                children: [],
                expanded: true
              },
            ],
            expanded: true
          },
          {
            id: 'zone-4',
            name: 'Swimming Pools',
            category: '',
            color: '#4fc3f7',
            relations: [],
            children: [
              {
                id: 'zone-5',
                name: 'Swimming lane 1',
                category: '',
                color: '#808080',
                relations: [],
                children: [],
                expanded: true
              },
              {
                id: 'zone-6',
                name: 'Swimming lane 2',
                category: '',
                color: '#ffa726',
                relations: [],
                children: [],
                expanded: true
              }
            ],
            expanded: true
          }
        ];

        // Generate random color
        function generateRandomColor() {
            const colors = [
                '#95B8A3', '#A8C5B8', '#8BA888', '#B8A895', '#A89588',
                '#95A8B8', '#8895A8', '#B895A8', '#A888B8', '#88A8B8',
                '#B8B895', '#A8B888', '#95B888', '#8898A8', '#B88895'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // UUID Generator
        function generateId() {
            return 'zone_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('facilityZones_v2');
            
            if (saved) {
                try {
                  const parsed = JSON.parse(saved);
                  if (Array.isArray(parsed) && parsed.every(z => z.id && z.name)) {
                    zones = parsed;
                  } else {
                    zones = defaultZones;
                    saveData();
                  }
                } catch {
                  zones = defaultZones;
                  saveData();
                }
              } else {
                zones = defaultZones;
                saveData();
              }
        
            renderZones();
        }

        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('facilityZones_v2', JSON.stringify(zones));
        }

        // Open Add Top-Level Zone Modal
        document.getElementById('addTopLevelZoneBtn').addEventListener('click', () => {
            currentEditingZone = null;
            currentParentZone = null;
            currentLevel = 0;
            openZoneModal('Add top-level Zone', 'Add zone');
        });

        // Open Zone Modal
        function openZoneModal(title, buttonText, zone = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('saveZoneBtn').textContent = buttonText;

            const nameInput = document.getElementById('zoneName');
            const categoryGroup = document.getElementById('zoneCategoryGroup'); // wrapper around the input+label
            const categoryInput = document.getElementById('zoneCategory');
            const colorInput = document.getElementById('colorInput');
            const colorPreview = document.getElementById('colorPreview');

            // ‚úÖ Show category input only if this is a top-level zone
            // If currentLevel is undefined, default to 0
            if (typeof currentLevel === 'undefined' || currentLevel === 0) {
                categoryGroup.style.display = ''; // visible
            } else {
                categoryGroup.style.display = 'none'; // hidden for child zones
                categoryInput.value = ''; // ensure empty
            }

            if (zone) {
                nameInput.value = zone.name;
                categoryInput.value = zone.category || '';
                colorInput.value = zone.color;
                colorPreview.style.backgroundColor = zone.color;
                currentEditingZone = zone;
            } else {
                nameInput.value = '';
                categoryInput.value = '';
                const randomColor = generateRandomColor();
                colorInput.value = randomColor;
                colorPreview.style.backgroundColor = randomColor;
            }

            updateRelationsDropdown();
            document.getElementById('zoneModal').classList.add('open');
        }

        // Close Zone Modal
        function closeZoneModal() {
            document.getElementById('zoneModal').classList.remove('open');
            currentEditingZone = null;
            currentParentZone = null;
        }

        // Update Relations Dropdown
        function updateRelationsDropdown() {
            const dropdown = document.getElementById('relationsDropdown');
            const input = document.getElementById('relationsInput');
            
            let availableZones = [];
            
            if (currentLevel === 0) {
                // Top-level: can relate to other top-level zones
                availableZones = zones.filter(z => 
                    (!currentEditingZone || z.id !== currentEditingZone.id)
                );
            } else if (currentLevel === 1) {
                // Sub-zone: can relate to siblings in same parent
                if (currentParentZone && currentParentZone.children) {
                    availableZones = currentParentZone.children.filter(z => 
                        (!currentEditingZone || z.id !== currentEditingZone.id)
                    );
                }
            } else if (currentLevel === 2) {
                // Sub-sub-zone: can relate to siblings in same sub-zone
                if (currentParentZone && currentParentZone.children) {
                    availableZones = currentParentZone.children.filter(z => 
                        (!currentEditingZone || z.id !== currentEditingZone.id)
                    );
                }
            }
            
            dropdown.innerHTML = '';
            availableZones.forEach(zone => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = zone.name;
                option.dataset.zoneId = zone.id;
                
                const isSelected = currentEditingZone && 
                    currentEditingZone.relations && 
                    currentEditingZone.relations.includes(zone.id);
                
                if (isSelected) {
                    option.classList.add('disabled');
                }
                
                option.addEventListener('click', () => {
                    if (!option.classList.contains('disabled')) {
                        toggleRelation(zone.id, zone.name);
                        option.classList.add('disabled');
                    }
                });
                
                dropdown.appendChild(option);
            });
            
            updateRelationsInput();
        }

        // Toggle Relations Dropdown
        document.getElementById('relationsInput').addEventListener('click', () => {
            const dropdown = document.getElementById('relationsDropdown');
            dropdown.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select-container')) {
                document.getElementById('relationsDropdown').classList.remove('open');
            }
        });

        // Toggle Relation
        function toggleRelation(zoneId, zoneName) {
            if (!currentEditingZone) {
                currentEditingZone = { relations: [] };
            }
            if (!currentEditingZone.relations) {
                currentEditingZone.relations = [];
            }
            
            const index = currentEditingZone.relations.indexOf(zoneId);
            if (index === -1) {
                currentEditingZone.relations.push(zoneId);
            } else {
                currentEditingZone.relations.splice(index, 1);
            }
            
            updateRelationsInput();
        }

        // Update Relations Input Display
        function updateRelationsInput() {
            const input = document.getElementById('relationsInput');
            input.innerHTML = '';
            
            if (!currentEditingZone || !currentEditingZone.relations || currentEditingZone.relations.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'multi-select-placeholder';
                placeholder.textContent = 'Select relations';
                input.appendChild(placeholder);
                return;
            }
            
            currentEditingZone.relations.forEach(relationId => {
                const relatedZone = findZoneById(relationId);
                if (relatedZone) {
                    const tag = document.createElement('div');
                    tag.className = 'multi-select-tag';
                    tag.innerHTML = `
                        ${relatedZone.name}
                        <span class="remove">√ó</span>
                    `;
                    tag.querySelector('.remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleRelation(relationId, relatedZone.name);
                        updateRelationsDropdown();
                    });
                    input.appendChild(tag);
                }
            });
        }

        // Color Picker
        document.getElementById('colorInput').addEventListener('input', (e) => {
            document.getElementById('colorPreview').style.backgroundColor = e.target.value;
        });

        // Save Zone
        document.getElementById('saveZoneBtn').addEventListener('click', () => {
            const name = document.getElementById('zoneName').value.trim();
            if (!name) {
                alert('Please enter a zone name');
                return;
            }
            
            const category = document.getElementById('zoneCategory').value;
            const color = document.getElementById('colorInput').value;
            const relations = currentEditingZone ? currentEditingZone.relations || [] : [];
            
            if (currentEditingZone && currentEditingZone.id) {
                // Edit existing zone
                currentEditingZone.name = name;
                currentEditingZone.category = category;
                currentEditingZone.color = color;
                currentEditingZone.relations = relations;
            } else {
                // Add new zone
                const newZone = {
                    id: generateId(),
                    name: name,
                    category: category,
                    color: color,
                    relations: relations,
                    children: [],
                    expanded: true,
                    showAlert: false
                };
                
                if (currentLevel === 0) {
                    zones.unshift(newZone); // Add to top of list
                } else if (currentParentZone) {
                    if (!currentParentZone.children) {
                        currentParentZone.children = [];
                    }
                    currentParentZone.children.push(newZone);
                    currentParentZone.expanded = true;
                }
            }
            
            // Add bidirectional relations
            relations.forEach(relationId => {
                const relatedZone = findZoneById(relationId);
                if (relatedZone) {
                    if (!relatedZone.relations) {
                        relatedZone.relations = [];
                    }
                    const zoneId = currentEditingZone ? currentEditingZone.id : zones[0].id;
                    if (!relatedZone.relations.includes(zoneId)) {
                        relatedZone.relations.push(zoneId);
                    }
                }
            });
            
            saveData();
            renderZones();
            closeZoneModal();
        });

        // Find Zone by ID
        function findZoneById(id, zoneList = zones) {
            for (let zone of zoneList) {
                if (zone.id === id) return zone;
                if (zone.children) {
                    const found = findZoneById(id, zone.children);
                    if (found) return found;
                }
            }
            return null;
        }

        // Find Parent Zone
        function findParentZone(zoneId, zoneList = zones, parent = null) {
            for (let zone of zoneList) {
                if (zone.id === zoneId) return parent;
                if (zone.children) {
                    const found = findParentZone(zoneId, zone.children, zone);
                    if (found !== undefined) return found;
                }
            }
            return undefined;
        }

        // Get Zone Level
        function getZoneLevel(zoneId, zoneList = zones, level = 0) {
            for (let zone of zoneList) {
                if (zone.id === zoneId) return level;
                if (zone.children) {
                    const found = getZoneLevel(zoneId, zone.children, level + 1);
                    if (found !== -1) return found;
                }
            }
            return -1;
        }

        // Render Zones
        function renderZones() {
            const container = document.getElementById('zonesList');
            container.innerHTML = '';
            zones.forEach(zone => {
                container.appendChild(renderZoneCard(zone, 0));
            });
        }

        // Render Zone Card
        function renderZoneCard(zone, level) {
            const card = document.createElement('div');
            card.className = level === 0 ? 'zone-card' : (level === 1 ? 'sub-zone' : 'sub-sub-zone');
            
            const header = document.createElement('div');
            header.className = 'zone-header';
            
            // Expand/Collapse Button
            const expandBtn = document.createElement('button');
            expandBtn.className = 'expand-btn';
            if (!zone.children || zone.children.length === 0) {
                expandBtn.classList.add('hidden');
            }
            expandBtn.innerHTML = zone.expanded ? '‚ñº' : '‚ñ∂';
            expandBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                zone.expanded = !zone.expanded;
                saveData();
                renderZones();
            });
            header.appendChild(expandBtn);
            
            // Color Indicator
            const colorDiv = document.createElement('div');
            colorDiv.className = 'zone-color';
            colorDiv.style.backgroundColor = zone.color;
            header.appendChild(colorDiv);
            
            // Zone Name
            const nameDiv = document.createElement('div');
            nameDiv.className = 'zone-name';
            nameDiv.textContent = zone.name;
            header.appendChild(nameDiv);
            
            // Badges
            const badgesDiv = document.createElement('div');
            badgesDiv.className = 'zone-badges';
            
            // Inner badge list container (where badges actually go)
            const badgeList = document.createElement('div');
            badgeList.className = 'badge-list';
            badgesDiv.appendChild(badgeList);
        
            
            // Category Badge
            if (zone.category) {
                badgesDiv.classList.add('category');
                
//                const categoryTitle = document.createElement('div');
//    categoryTitle.className = 'badge-title';
//    categoryTitle.textContent = 'Category:';
//    badgesDiv.appendChild(categoryTitle);

                const categoryBadge = document.createElement('span');
                categoryBadge.className = 'badge category';
                categoryBadge.textContent = zone.category;
                
                 if (typeof showCategoryBadgePopover === 'function') {
                    categoryBadge.addEventListener('mouseenter', (e) => showCategoryBadgePopover(e, zone));
                    categoryBadge.addEventListener('mouseleave', hideBadgePopover);
                 }
                
                badgeList.appendChild(categoryBadge);
            }
            
            // Relation Badges
            if (zone.relations && zone.relations.length > 0) {

//                const relationsTitle = document.createElement('div');
//    relationsTitle.className = 'badge-title';
//    relationsTitle.textContent = 'This sub-zone cannot be booked at the same time with:';
//    badgesDiv.appendChild(relationsTitle);
                
                zone.relations.forEach(relationId => {
                    const relatedZone = findZoneById(relationId);
                    if (relatedZone) {
                        const relationBadge = document.createElement('span');
                        relationBadge.className = 'badge relation';
                        relationBadge.textContent = relatedZone.name;
                        if (typeof showRelationBadgePopover === 'function') {
                            relationBadge.addEventListener('mouseenter', (e) => showRelationBadgePopover(e, zone, relatedZone));
                            relationBadge.addEventListener('mouseleave', hideBadgePopover);
                        }
                        
                        badgeList.appendChild(relationBadge);
                    }
                });
            }
            
            header.appendChild(badgesDiv);
            
            // Actions
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'zone-actions';
            
            // Add Child Button 
            if (level < 5) {
                const addBtn = document.createElement('button');
                addBtn.className = 'icon-btn';
                addBtn.innerHTML = '<i>+</i>';
                addBtn.title = 'Add sub-zone';
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addSubZone(zone, level + 1);
                });
                actionsDiv.appendChild(addBtn);
            }
            
            // More Options Button
            const moreBtn = document.createElement('button');
            moreBtn.className = 'icon-btn context-m';
            moreBtn.innerHTML = '‚ãÆ';
            moreBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showContextMenu(e, zone);
            });
            actionsDiv.appendChild(moreBtn);
            
            header.appendChild(actionsDiv);
            card.appendChild(header);
            
//            if (level === 0) {
//                const parentInfo = document.createElement('div');
//                parentInfo.className = 'zone-relation-parent';
//                parentInfo.textContent =
//                    'If the parent element is booked, the sub-zone cannot be booked.';
//                header.appendChild(parentInfo);
//            }
            
//            // ‚úÖ Insert alert notification here
//              if (level === 0 && zone.showAlert) {
//                const alertDiv = document.createElement('div');
//                alertDiv.id = 'zoneAlert';
//                alertDiv.className = 'zone-alert';
//
//                alertDiv.innerHTML = '<span class="info-icon">i</span><p>You‚Äôve added additional zones without a <b>booking relation</b>. Are you sure these zones can be booked at the same time?</p> <button class="alert-button" onclick="closeZoneAlert()">Yes, Im sure</button> <button class="alert-button" onclick="openEditZone()">Edit zone</button> <button class="modal-close" onclick="closeZoneAlert()">√ó</button>';
//
//                card.appendChild(alertDiv);
//
//              }
            
            // Children Container
            if (zone.children && zone.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'zone-children';
                if (!zone.expanded) {
                    childrenDiv.classList.add('collapsed');
                }
                
                zone.children.forEach(child => {
                    childrenDiv.appendChild(renderZoneCard(child, level + 1));
                });
                
                card.appendChild(childrenDiv);
            }
            
            return card;
        }

        // Add Sub-Zone
        function addSubZone(parentZone, level) {
            if (!parentZone.children) {
                parentZone.children = [];
            }
            
            // Create a temporary zone form element
            const formZone = {
                id: 'temp_' + Date.now(),
                name: '',
                category: '',
                color: generateRandomColor(),
                relations: [],
                isForm: true
            };
            
            parentZone.children.unshift(formZone);
            parentZone.expanded = true;
            
            
            // üëá check if parent is a top-level zone and has 3 children now
              if (level === 1 && parentZone.children.length === 3) {
                parentZone.showAlert = true;
              }
            
            
            saveData();
            renderZones();
            
            // Find and render the form
            setTimeout(() => {
                renderSubZoneForm(parentZone, formZone, level);
            }, 0);
        }

        // Render Sub-Zone Form
        function renderSubZoneForm(parentZone, formZone, level) {
            const parentCard = document.querySelector(`[data-zone-id="${parentZone.id}"]`);
            if (!parentCard) {
                // Find by traversing
                const allCards = document.querySelectorAll('.zone-card, .sub-zone, .sub-sub-zone');
                // For simplicity, re-render with form
                renderZonesWithForm(parentZone, formZone, level);
            }
        }

        // Render Zones with Form
        function renderZonesWithForm(parentZone, formZone, level) {
            const container = document.getElementById('zonesList');
            container.innerHTML = '';
            zones.forEach(zone => {
                container.appendChild(renderZoneCardWithForm(zone, 0, parentZone, formZone, level));
            });
        }

        // Render Zone Card With Form
        function renderZoneCardWithForm(zone, currentLevel, targetParent, formZone, targetLevel) {
            const card = document.createElement('div');
            card.className = currentLevel === 0 ? 'zone-card' : (currentLevel === 1 ? 'sub-zone' : 'sub-sub-zone');
            
            const header = document.createElement('div');
            header.className = 'zone-header';
            
            // Expand/Collapse Button
            const expandBtn = document.createElement('button');
            expandBtn.className = 'expand-btn';
            if (!zone.children || zone.children.length === 0 || (zone.children.length === 1 && zone.children[0].isForm)) {
                expandBtn.classList.add('hidden');
            }
            expandBtn.innerHTML = zone.expanded ? '‚ñº' : '‚ñ∂';
            expandBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                zone.expanded = !zone.expanded;
                saveData();
                renderZonesWithForm(targetParent, formZone, targetLevel);
            });
            header.appendChild(expandBtn);
            
            // Color Indicator
            const colorDiv = document.createElement('div');
            colorDiv.className = 'zone-color';
            colorDiv.style.backgroundColor = zone.color;
            header.appendChild(colorDiv);
            
            // Zone Name
            const nameDiv = document.createElement('div');
            nameDiv.className = 'zone-name';
            nameDiv.textContent = zone.name;
            header.appendChild(nameDiv);
            
            // Badges
            const badgesDiv = document.createElement('div');
            badgesDiv.className = 'zone-badges';
            
            // Inner badge list container (where badges actually go)
            const badgeList = document.createElement('div');
            badgeList.className = 'badge-list';
            badgesDiv.appendChild(badgeList);
            
            if (zone.category) {
                badgesDiv.classList.add('category');
                
//                const categoryTitle = document.createElement('div');
//    categoryTitle.className = 'badge-title';
//    categoryTitle.textContent = 'Category:';
//    badgesDiv.appendChild(categoryTitle);

                const categoryBadge = document.createElement('span');
                categoryBadge.className = 'badge category';
                categoryBadge.textContent = zone.category;
                if (typeof showCategoryBadgePopover === 'function') {
                    categoryBadge.addEventListener('mouseenter', (e) => showCategoryBadgePopover(e, zone));
                    categoryBadge.addEventListener('mouseleave', hideBadgePopover);
                }
                badgeList.appendChild(categoryBadge);
            }
            
            if (zone.relations && zone.relations.length > 0) {
                
//                const relationsTitle = document.createElement('div');
//    relationsTitle.className = 'badge-title';
//    relationsTitle.textContent = 'This zone cannot be booked at the same time with:';
//    badgesDiv.appendChild(relationsTitle);
                
                zone.relations.forEach(relationId => {
                    const relatedZone = findZoneById(relationId);
                    if (relatedZone) {
                        const relationBadge = document.createElement('span');
                        relationBadge.className = 'badge relation';
                        relationBadge.textContent = relatedZone.name;
                        if (typeof showRelationBadgePopover === 'function') {
                            relationBadge.addEventListener('mouseenter', (e) => showRelationBadgePopover(e, zone, relatedZone));
                            relationBadge.addEventListener('mouseleave', hideBadgePopover);
                        }
                        badgeList.appendChild(relationBadge);
                    }
                });
            }
            
            header.appendChild(badgesDiv);
            
            // Actions
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'zone-actions';
            
            if (currentLevel < 2) {
                const addBtn = document.createElement('button');
                addBtn.className = 'icon-btn';
                addBtn.innerHTML = '<i>+</i>';
                addBtn.title = 'Add sub-zone';
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addSubZone(zone, currentLevel + 1);
                });
                actionsDiv.appendChild(addBtn);
            }
            
            const moreBtn = document.createElement('button');
            moreBtn.className = 'icon-btn context-m';
            moreBtn.innerHTML = '‚ãÆ';
            moreBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showContextMenu(e, zone);
            });
            actionsDiv.appendChild(moreBtn);
            
            header.appendChild(actionsDiv);
            card.appendChild(header);
            
            
            
            
            
            // Children Container
            if (zone.children && zone.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'zone-children';
                if (!zone.expanded) {
                    childrenDiv.classList.add('collapsed');
                }
                
                zone.children.forEach(child => {
                    if (child.isForm && zone === targetParent) {
                        childrenDiv.appendChild(createZoneForm(targetParent, formZone, targetLevel));
                    } else if (!child.isForm) {
                        childrenDiv.appendChild(renderZoneCardWithForm(child, currentLevel + 1, targetParent, formZone, targetLevel));
                    }
                });
                
                card.appendChild(childrenDiv);
            }
            
            return card;
        }

        // Create Zone Form
        function createZoneForm(parentZone, formZone, level) {
            const form = document.createElement('div');
            form.className = 'zone-form';
            
            // Color and Name
            const nameGroup = document.createElement('div');
            nameGroup.className = 'form-group';
            nameGroup.innerHTML = `
                <label class="form-label">Name <span class="required">*</span></label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="color-preview" style="background-color: ${formZone.color}; flex-shrink: 0;" id="formColorPreview_${formZone.id}"></div>
                    <input type="text" class="form-input" id="formName_${formZone.id}" placeholder="Enter zone name" style="flex: 1;">
                </div>
                <input type="color" class="color-input" id="formColorInput_${formZone.id}" value="${formZone.color}">
            `;
            form.appendChild(nameGroup);
            
            // Category
            if (level === 0) {
                const categoryGroup = document.createElement('div');
                categoryGroup.className = 'form-group';
                categoryGroup.innerHTML = `
                    <label class="form-label">
                        Facility category
                        <span class="info-icon" id="formCategoryInfo_${formZone.id}">i</span>
                    </label>
                    <select class="form-select" id="formCategory_${formZone.id}">
                        <option value="">Select category</option>
                        <option value="Swimming">Swimming</option>
                        <option value="Personal Training">Personal Training</option>
                        <option value="Parking">Parking</option>
                        <option value="Yoga">Yoga</option>
                    </select>
                `;
                form.appendChild(categoryGroup);
            }
            // Relations
            const relationsGroup = document.createElement('div');
            relationsGroup.className = 'form-group';
            relationsGroup.innerHTML = `
                <label class="form-label">
                    Booking relations
                    <span class="info-icon" id="formRelationsInfo_${formZone.id}">i</span>
                </label>
                <div class="multi-select-container">
                    <div class="multi-select-input" id="formRelationsInput_${formZone.id}">
                        <span class="multi-select-placeholder">Select relations</span>
                    </div>
                    <div class="multi-select-dropdown" id="formRelationsDropdown_${formZone.id}"></div>
                </div>
            `;
            form.appendChild(relationsGroup);
            
            // Actions
            const actionsGroup = document.createElement('div');
            actionsGroup.className = 'form-actions';
            actionsGroup.innerHTML = `
                <button class="btn btn-secondary" id="formCancel_${formZone.id}">Cancel</button>
                <button class="btn btn-primary" id="formSave_${formZone.id}">Add zone</button>
            `;
            form.appendChild(actionsGroup);
            
            // Add event listeners after rendering
            setTimeout(() => {
                // Color picker
                const colorInput = document.getElementById(`formColorInput_${formZone.id}`);
                const colorPreview = document.getElementById(`formColorPreview_${formZone.id}`);
                colorPreview.addEventListener('click', () => colorInput.click());
                colorInput.addEventListener('input', (e) => {
                    colorPreview.style.backgroundColor = e.target.value;
                    formZone.color = e.target.value;
                });
                
                // Info icons
                const categoryInfoEl = document.getElementById(`formCategoryInfo_${formZone.id}`);
                if (categoryInfoEl) {
                    categoryInfoEl.addEventListener('click', (e) => {
                        showInfoPopover(e, 'category');
                    });
                }
                document.getElementById(`formRelationsInfo_${formZone.id}`).addEventListener('click', (e) => {
                    showInfoPopover(e, 'relations');
                });
                
                // Relations multi-select
                setupFormRelations(parentZone, formZone, level);
                
                // Cancel button
                document.getElementById(`formCancel_${formZone.id}`).addEventListener('click', () => {
                    cancelSubZoneForm(parentZone, formZone);
                });
                
                // Save button
                document.getElementById(`formSave_${formZone.id}`).addEventListener('click', () => {
                    saveSubZoneForm(parentZone, formZone, level);
                });
            }, 0);
            
            return form;
        }

        // Setup Form Relations
        function setupFormRelations(parentZone, formZone, level) {
            const input = document.getElementById(`formRelationsInput_${formZone.id}`);
            const dropdown = document.getElementById(`formRelationsDropdown_${formZone.id}`);
            
            let availableZones = [];
            
            if (level === 1) {
                // Sub-zone: can relate to siblings
                availableZones = parentZone.children.filter(z => z.id !== formZone.id && !z.isForm);
            } else if (level === 2) {
                // Sub-sub-zone: can relate to siblings
                availableZones = parentZone.children.filter(z => z.id !== formZone.id && !z.isForm);
            }
            
            dropdown.innerHTML = '';
            availableZones.forEach(zone => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.textContent = zone.name;
                option.dataset.zoneId = zone.id;
                
                option.addEventListener('click', () => {
                    if (!formZone.relations) formZone.relations = [];
                    if (!formZone.relations.includes(zone.id)) {
                        formZone.relations.push(zone.id);
                        option.classList.add('disabled');
                        updateFormRelationsInput(formZone);
                    }
                });
                
                dropdown.appendChild(option);
            });
            
            input.addEventListener('click', () => {
                dropdown.classList.toggle('open');
            });
            
            updateFormRelationsInput(formZone);
        }

        // Update Form Relations Input
        function updateFormRelationsInput(formZone) {
            const input = document.getElementById(`formRelationsInput_${formZone.id}`);
            if (!input) return;
            
            input.innerHTML = '';
            
            if (!formZone.relations || formZone.relations.length === 0) {
                const placeholder = document.createElement('span');
                placeholder.className = 'multi-select-placeholder';
                placeholder.textContent = 'Select relations';
                input.appendChild(placeholder);
                return;
            }
            
            formZone.relations.forEach(relationId => {
                const relatedZone = findZoneById(relationId);
                if (relatedZone) {
                    const tag = document.createElement('div');
                    tag.className = 'multi-select-tag';
                    tag.innerHTML = `
                        ${relatedZone.name}
                        <span class="remove">√ó</span>
                    `;
                    tag.querySelector('.remove').addEventListener('click', (e) => {
                        e.stopPropagation();
                        formZone.relations = formZone.relations.filter(id => id !== relationId);
                        updateFormRelationsInput(formZone);
                        
                        // Re-enable in dropdown
                        const dropdown = document.getElementById(`formRelationsDropdown_${formZone.id}`);
                        const option = dropdown.querySelector(`[data-zone-id="${relationId}"]`);
                        if (option) option.classList.remove('disabled');
                    });
                    input.appendChild(tag);
                }
            });
        }

        // Cancel Sub-Zone Form
        function cancelSubZoneForm(parentZone, formZone) {
            parentZone.children = parentZone.children.filter(z => z.id !== formZone.id);
            saveData();
            renderZones();
        }

        // Save Sub-Zone Form
        function saveSubZoneForm(parentZone, formZone, level) {
            const name = document.getElementById(`formName_${formZone.id}`).value.trim();
            if (!name) {
                alert('Please enter a zone name');
                return;
            }
            
            const categoryInput = document.getElementById(`formCategory_${formZone.id}`);
            const category = categoryInput ? categoryInput.value : '';
            
            // Create actual zone
            const newZone = {
                id: generateId(),
                name: name,
                category: category,
                color: formZone.color,
                relations: formZone.relations || [],
                children: [],
                expanded: true
            };
            
            // Replace form zone with actual zone
            const index = parentZone.children.findIndex(z => z.id === formZone.id);
            if (index !== -1) {
                parentZone.children[index] = newZone;
            }
            
            // Add bidirectional relations
            if (newZone.relations) {
                newZone.relations.forEach(relationId => {
                    const relatedZone = findZoneById(relationId);
                    if (relatedZone) {
                        if (!relatedZone.relations) {
                            relatedZone.relations = [];
                        }
                        if (!relatedZone.relations.includes(newZone.id)) {
                            relatedZone.relations.push(newZone.id);
                        }
                    }
                });
            }
            
            saveData();
            renderZones();
        }

        // Show Context Menu
        function showContextMenu(event, zone) {
            event.preventDefault();
            const menu = document.getElementById('contextMenu');
            contextMenuTarget = zone;
            
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('open');
        }

        // Hide Context Menu
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').classList.remove('open');
        });

        // Edit Zone Menu Item
        document.getElementById('editZoneMenuItem').addEventListener('click', () => {
            if (contextMenuTarget) {
                const level = getZoneLevel(contextMenuTarget.id);
                const parent = findParentZone(contextMenuTarget.id);
                
                currentEditingZone = contextMenuTarget;
                currentParentZone = parent;
                currentLevel = level;
                
                const title = level === 0 ? 'Edit top-level Zone' : 'Edit Zone';
                openZoneModal(title, 'Save changes', contextMenuTarget);
            }
        });

        // Delete Zone Menu Item
        document.getElementById('deleteZoneMenuItem').addEventListener('click', () => {
            if (contextMenuTarget) {
                openDeleteModal(contextMenuTarget);
            }
        });

        // Open Delete Modal
        function openDeleteModal(zone) {
            let message = `Are you sure you want to delete "${zone.name}"?`;
            if (zone.children && zone.children.length > 0) {
                message += ' This will also delete all sub-zones.';
            }
            
            document.getElementById('deleteMessage').textContent = message;
            document.getElementById('deleteModal').classList.add('open');
            
            document.getElementById('confirmDeleteBtn').onclick = () => {
                deleteZone(zone);
                closeDeleteModal();
            };
        }

        // Close Delete Modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('open');
        }
        
        // Close Info Alert
        function closeInfoAlert() {
            document.getElementById('infoAlert').classList.add('close');
        }
        // Close Zone Alert
        function closeZoneAlert() {
            document.getElementById('zoneAlert').classList.add('close');
        }
        // Open Edit Zone
        function openEditZone() {
            if (contextMenuTarget) {
                const level = getZoneLevel(contextMenuTarget.id);
                const parent = findParentZone(contextMenuTarget.id);
                
                currentEditingZone = contextMenuTarget;
                currentParentZone = parent;
                currentLevel = level;
                
                const title = level === 0 ? 'Edit top-level Zone' : 'Edit Zone';
                openZoneModal(title, 'Save changes', contextMenuTarget);
            }
        }
        
        //Add Category Modal
      const addCategoryModal = document.getElementById('addCategoryModal');
      const categoryNameInput = document.getElementById('categoryName');
//      const colorInput = document.getElementById('categoryColorInput');
      const colorPicker = document.getElementById('categoryColorPicker');
//      const colorPreview = document.getElementById('categoryColorPreview');
      const saveBtn = document.getElementById('saveAddCategoryBtn');
      const cancelBtn = document.getElementById('cancelAddCategoryBtn');
      const closeBtn = document.getElementById('closeAddCategoryBtn');
      const categorySelect = document.getElementById('zoneCategory');
      const facilityToggle = document.getElementById('facilityToggle');
      const facilityDropdown = document.getElementById('facilityDropdown');

          // Toggle facility dropdown open/close
          facilityToggle.addEventListener('click', () => {
            facilityDropdown.classList.toggle('open');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!facilityDropdown.contains(e.target) && !facilityToggle.contains(e.target)) {
              facilityDropdown.classList.remove('open');
            }
          });

          // Update facility button text when selection changes
            facilityDropdown.addEventListener('change', () => {
              const selectedFacilities = Array.from(facilityDropdown.querySelectorAll('input:checked'));
              const count = selectedFacilities.length;

              facilityToggle.querySelector('span').textContent =
                count > 0 ? `${count} facilit${count > 1 ? 'ies' : 'y'} selected` : 'Current facility';
            });

//          // Color picker updates
//          colorPicker.addEventListener('input', () => {
//            colorInput.value = colorPicker.value;
//            colorPreview.style.backgroundColor = colorPicker.value;
//          });

          // Handle "Add new category" from select
          categorySelect.addEventListener('change', (e) => {
            if (e.target.value === '_addNew') {
              openAddCategoryModal();
            }
          });

          // Save new category
          saveBtn.addEventListener('click', () => {
            const name = categoryNameInput.value.trim();
            const color = colorInput.value.trim() || '#cccccc';
            const facilities = Array.from(facilityDropdown.querySelectorAll('input:checked')).map(cb => cb.value);

            if (!name) {
              alert('Please enter a category name.');
              return;
            }

            // Store the new category info (example: in localStorage)
            const stored = JSON.parse(localStorage.getItem('categories') || '[]');
            stored.push({ name, color, facilities });
            localStorage.setItem('categories', JSON.stringify(stored));

            // Add to select dropdown
            const newOption = document.createElement('option');
            newOption.value = name;
            newOption.textContent = name;
            newOption.dataset.color = color;
            categorySelect.insertBefore(newOption, categorySelect.querySelector('option[value="_addNew"]'));
            categorySelect.value = name;

            closeAddCategoryModal();
          });

          cancelBtn.addEventListener('click', closeAddCategoryModal);
          closeBtn.addEventListener('click', closeAddCategoryModal);

          function openAddCategoryModal() {
            categoryNameInput.value = '';
            const randomColor = generateRandomColor();
            colorPicker.value = randomColor;
            colorInput.value = randomColor;
//            colorPreview.style.backgroundColor = randomColor;
            facilityDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            facilityToggle.querySelector('span').textContent = 'Current facility';
            addCategoryModal.classList.add('open');
          }

          function closeAddCategoryModal() {
            addCategoryModal.classList.remove('open');
          }
        

        // Delete Zone
        function deleteZone(zone) {
            // Remove relations from other zones
            if (zone.relations) {
                zone.relations.forEach(relationId => {
                    const relatedZone = findZoneById(relationId);
                    if (relatedZone && relatedZone.relations) {
                        relatedZone.relations = relatedZone.relations.filter(id => id !== zone.id);
                    }
                });
            }
            
            // Remove references to this zone from others
            function removeReferences(zoneList) {
                zoneList.forEach(z => {
                    if (z.relations) {
                        z.relations = z.relations.filter(id => id !== zone.id);
                    }
                    if (z.children) {
                        removeReferences(z.children);
                    }
                });
            }
            removeReferences(zones);
            
            // Remove zone from parent or root
            const parent = findParentZone(zone.id);
            if (parent) {
                parent.children = parent.children.filter(z => z.id !== zone.id);
            } else {
                zones = zones.filter(z => z.id !== zone.id);
            }
            
            saveData();
            renderZones();
        }

        // Show Category Badge Popover
        function showCategoryBadgePopover(event, zone) {
            const popover = document.getElementById('badgePopover');
            popover.textContent = `Facility category. ${zone.category} Category linked to ${zone.category} Service.`;
            popover.style.left = event.pageX + 'px';
            popover.style.top = (event.pageY + 20) + 'px';
            popover.classList.add('open');
        }

        // Show Relation Badge Popover
        function showRelationBadgePopover(event, zone, relatedZone) {
            const popover = document.getElementById('badgePopover');
            popover.textContent = `Booking relations. Booking ${relatedZone.name} zone blocks ${zone.name} from being booked at the same time. This ensures proper space management.`;
            popover.style.left = event.pageX + 'px';
            popover.style.top = (event.pageY + 20) + 'px';
            popover.classList.add('open');
        }

        // Hide Badge Popover
        function hideBadgePopover() {
            document.getElementById('badgePopover').classList.remove('open');
        }

        // Show Info Popover
        function showInfoPopover(event, type) {
            const popover = type === 'category' 
                ? document.getElementById('categoryInfoPopover')
                : document.getElementById('relationsInfoPopover');
            
            // Close other popovers
            document.getElementById('categoryInfoPopover').classList.remove('open');
            document.getElementById('relationsInfoPopover').classList.remove('open');
            
            const rect = event.target.getBoundingClientRect();
            popover.style.left = (rect.left + window.scrollX) + 'px';
            popover.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            popover.classList.add('open');
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', function closePopover(e) {
                    if (!popover.contains(e.target) && e.target !== event.target) {
                        popover.classList.remove('open');
                        document.removeEventListener('click', closePopover);
                    }
                });
            }, 0);
        }
        
        //Dialog opovers
        const dialogCategory = document.getElementById('dialogCategory');
        const dialogRelations = document.getElementById('dialogRelations');

        if (dialogCategory) {
            dialogCategory.addEventListener('click', (e) => {
                e.stopPropagation();
                showInfoPopover(e, 'category');
            });
        }

        if (dialogRelations) {
            dialogRelations.addEventListener('click', (e) => {
                e.stopPropagation();
                showInfoPopover(e, 'relations');
            });
        }

        // Initialize
        loadData();
        
    // Banner
        let currentSlide = 0;
        const totalSlides = 4;
        const sliderWrapper = document.getElementById('sliderWrapper');
        const pageIndicator = document.getElementById('pageIndicator');
        const nextBtn = document.getElementById('nextBtn');

        function updateSlider() {
            const slideWidth = sliderWrapper.parentElement.offsetWidth;
            sliderWrapper.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
            pageIndicator.textContent = `${currentSlide + 1} of ${totalSlides}`;
            
            // Update button text on last slide
            if (currentSlide === totalSlides - 1) {
                nextBtn.textContent = 'Back to the first slide';
            } else {
                nextBtn.textContent = 'Next';
            }
        }

        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
            } else {
                currentSlide = 0; // Go back to first slide
            }
            updateSlider();
        }


        // Handle window resize to recalculate slide positions
        window.addEventListener('resize', () => {
            updateSlider();
        });

        // Initialize
        updateSlider();
        
        
        //Close Banner
        function closeBanner() {
            document.getElementById('closeBanner').classList.add('closed');
        }
        
//        Review dialog
        function openDialog() {
            document.getElementById('dialogOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeDialog() {
            document.getElementById('dialogOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function closeDialogOnOverlay(event) {
            if (event.target === document.getElementById('dialogOverlay')) {
                closeDialog();
            }
        }

        function toggleZone(zoneId) {
            const content = document.getElementById(zoneId);
            const icon = event.target;
            
            content.classList.toggle('active');
            icon.classList.toggle('expanded');
        }

        // Close dialog with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeDialog();
            }
        });
        
    </script>
</body>
</html>
